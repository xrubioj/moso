name: macOS Universal Build + DMG

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: macos-26
    env:
      APP_NAME: Moso

    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app

      - name: Build Universal App
        run: |
          xcodebuild \
            -project "${{ env.APP_NAME }}.xcodeproj" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -arch arm64 -arch x86_64 \
            build

      - name: Prepare App Bundle
        run: |
          set -e
          APP_NAME="${{ env.APP_NAME }}"
          echo "Looking for ${APP_NAME}.app in DerivedData..."
          APP_PATH="$(find ~/Library/Developer/Xcode/DerivedData -type d -name "${APP_NAME}.app" -print -quit 2>/dev/null || true)"

          if [ -z "$APP_PATH" ]; then
            echo "Not found in DerivedData â€” searching build/Release..."
            APP_PATH="$(find build -type d -name "${APP_NAME}.app" -print -quit 2>/dev/null || true)"
          fi

          if [ -z "$APP_PATH" ]; then
            echo "Searching ~/Library/Developer/Xcode/DerivedData/*/Build/Products/*/Release for ${APP_NAME}.app..."
            APP_PATH="$(find ~/Library/Developer/Xcode/DerivedData -path "*/Build/Products/*/Release/${APP_NAME}.app" -print -quit 2>/dev/null || true)"
          fi

          if [ -z "$APP_PATH" ]; then
            echo "ERROR: ${APP_NAME}.app not found. Searched DerivedData and build directories." >&2
            echo "List of DerivedData directories for debugging:"
            ls -la ~/Library/Developer/Xcode/DerivedData || true
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          mkdir -p dist
          /usr/bin/ditto "$APP_PATH" "dist/${APP_NAME}.app"
          echo "Copied to dist/${APP_NAME}.app"

      - name: Upload App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-macOS-Universal-app"
          path: dist/

      - name: Create DMG
        run: |
          set -e
          APP_NAME="${{ env.APP_NAME }}"
          mkdir dmg_src
          cp -R "dist/${APP_NAME}.app" dmg_src/

          hdiutil create \
            -volname "${APP_NAME}" \
            -srcfolder dmg_src \
            -format UDZO \
            -ov \
            "dist/${APP_NAME}.dmg"

          echo "DMG created at dist/${APP_NAME}.dmg"

      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-macOS-Universal-dmg"
          path: dist/${{ env.APP_NAME }}.dmg
