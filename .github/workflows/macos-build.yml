name: macOS Universal Build + DMG

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: macos-26
    env:
      APP_NAME: Moso

    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app

      - name: Build Universal App
        run: |
          set -e
          xcodebuild \
            -project "${{ env.APP_NAME }}.xcodeproj" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -derivedDataPath ./DerivedData \
            ARCHS="arm64 x86_64" \
            clean build

      - name: Prepare App Bundle
        run: |
          set -e
          APP_NAME="${{ env.APP_NAME }}"
          echo "Expecting ${APP_NAME}.app in ./DerivedData/Build/Products/Release..."
          APP_PATH="$(pwd)/DerivedData/Build/Products/Release/${APP_NAME}.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: ${APP_NAME}.app not found at expected path: $APP_PATH" >&2
            echo "Listing DerivedData Build/Products for debugging:"
            ls -la ./DerivedData/Build/Products || true
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          mkdir -p dist
          /usr/bin/ditto "$APP_PATH" "dist/${APP_NAME}.app"
          echo "Copied to dist/${APP_NAME}.app"

      - name: Upload App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-macOS-Universal-app"
          path: dist/

      - name: Create DMG
        run: |
          set -e
          APP_NAME="${{ env.APP_NAME }}"
          mkdir dmg_src
          cp -R "dist/${APP_NAME}.app" dmg_src/

          ln -s /Applications dmg_src/Applications || true

          hdiutil create \
            -volname "${APP_NAME}" \
            -srcfolder dmg_src \
            -format UDZO \
            -ov \
            "dist/${APP_NAME}.dmg"

          echo "DMG created at dist/${APP_NAME}.dmg"

      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-macOS-Universal-dmg"
          path: dist/${{ env.APP_NAME }}.dmg